apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: status

resources:
  - namespace.yaml
  - ingress.yaml

helmCharts:
  - name: gatus
    repo: https://twin.github.io/helm-charts
    version: 1.4.4
    releaseName: gatus
    namespace: status
    valuesInline:
      nodeSelector:
        kubernetes.io/hostname: talos-ramhaus
      persistence:
        enabled: true
        size: 1Gi
        storageClassName: nfs
      serviceMonitor:
        enabled: true
      config:
        storage:
          type: sqlite
          path: /data/gatus.db
        ui:
          title: "asandov.com Status"
          header: "Service Status"
        endpoints:
          # Public services
          - name: Authentik
            group: Public
            url: https://auth.asandov.com
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          - name: Jellyseerr
            group: Public
            url: https://jellyseerr.asandov.com
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          # Media stack (internal)
          - name: Sonarr
            group: Media
            url: http://sonarr.media-v2.svc.cluster.local:8989/ping
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          - name: Radarr
            group: Media
            url: http://radarr.media-v2.svc.cluster.local:7878/ping
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          - name: Prowlarr
            group: Media
            url: http://prowlarr.media-v2.svc.cluster.local:9696/ping
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          - name: SABnzbd
            group: Media
            url: http://sabnzbd.media-v2.svc.cluster.local:8080
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          - name: Bazarr
            group: Media
            url: http://bazarr.media-v2.svc.cluster.local:6767
            interval: 60s
            conditions:
              - "[STATUS] == 200"
          # Infrastructure
          - name: NFS
            group: Infrastructure
            url: tcp://truenas.asandov.local:2049
            interval: 30s
            conditions:
              - "[CONNECTED] == true"
          - name: TrueNAS
            group: Infrastructure
            url: https://truenas.asandov.local
            interval: 60s
            client:
              insecure: true
            conditions:
              - "[STATUS] == 200"
          - name: Kubernetes API
            group: Infrastructure
            url: https://kubernetes.default.svc.cluster.local:443
            interval: 30s
            client:
              insecure: true
            conditions:
              - "[STATUS] == any(200, 401, 403)"
          - name: Victoria Metrics
            group: Infrastructure
            url: http://vmsingle-vm-victoria-metrics-k8s-stack.monitoring.svc.cluster.local:8428/health
            interval: 30s
            conditions:
              - "[STATUS] == 200"
          - name: VMAgent
            group: Infrastructure
            url: http://vmagent-vm-victoria-metrics-k8s-stack.monitoring.svc.cluster.local:8429/health
            interval: 30s
            conditions:
              - "[STATUS] == 200"
          - name: VMAlert
            group: Infrastructure
            url: http://vmalert-vm-victoria-metrics-k8s-stack.monitoring.svc.cluster.local:8080/health
            interval: 30s
            conditions:
              - "[STATUS] == 200"
          - name: Victoria Logs
            group: Infrastructure
            url: http://victoria-logs-victoria-logs-single-server.monitoring.svc.cluster.local:9428/health
            interval: 30s
            conditions:
              - "[STATUS] == 200"
          - name: Lab DNS
            group: Infrastructure
            url: 10.0.1.1
            interval: 30s
            dns:
              query-name: truenas.asandov.local
              query-type: A
            conditions:
              - "[DNS_RCODE] == NOERROR"
          - name: Cloudflare DNS
            group: Infrastructure
            url: 1.1.1.1
            interval: 30s
            dns:
              query-name: cloudflare.com
              query-type: A
            conditions:
              - "[DNS_RCODE] == NOERROR"
