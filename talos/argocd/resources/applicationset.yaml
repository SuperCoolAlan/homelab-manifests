apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: talos-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: https://github.com/SuperCoolAlan/homelab-manifests.git
        revision: HEAD
        directories:
          # Cluster services
          - path: talos/cluster-services/*
          # Exclude kube-prometheus-stack (replaced by victoria-metrics)
          - path: talos/cluster-services/monitoring
            exclude: true
          # Monitoring sub-apps
          - path: talos/monitoring/*
          # Authentik
          - path: talos/authentik
          # Media apps
          - path: talos/media-v2
          - path: talos/qbittorrent
          # Tracearr
          - path: talos/tracearr
          # Maintainerr
          - path: talos/maintainerr
          # Piper (TTS)
          - path: talos/piper
          # Status page
          - path: talos/status
          # Twingate
          - path: talos/twingate
          # Security scanning
          - path: talos/security/*
  template:
    metadata:
      name: '{{.path.basename}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/SuperCoolAlan/homelab-manifests.git
        targetRevision: HEAD
        path: '{{.path.path}}'
      destination:
        server: https://kubernetes.default.svc
      syncPolicy:
        syncOptions:
          - ServerSideApply=true
      ignoreDifferences:
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          jsonPointers:
            - /status
            - /spec/conversion/webhook/clientConfig/caBundle
