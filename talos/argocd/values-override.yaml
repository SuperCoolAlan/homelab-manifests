# ArgoCD values override for Talos cluster
global:
  image:
    tag: v3.2.2

configs:
  cm:
    # Enable Helm support and alpha plugins (including ksops) in Kustomize builds
    kustomize.buildOptions: "--enable-helm --enable-alpha-plugins --enable-exec"
  params:
    # Keep the insecure mode we just configured
    server.insecure: true

# Install ksops in standard ArgoCD repo server
repoServer:
  env:
    - name: KUSTOMIZE_PLUGIN_HOME
      value: /home/argocd/.config/kustomize/plugin
    - name: XDG_CONFIG_HOME
      value: /home/argocd/.config
    - name: PATH
      value: /home/argocd/.config/kustomize/plugin/viaduct.ai/v1/ksops:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: SOPS_GNUPGHOME
      value: /home/argocd/.gnupg
    - name: GNUPGHOME
      value: /home/argocd/.gnupg
  volumes:
    - name: custom-tools
      emptyDir: {}
    - name: gnupg-home
      emptyDir: {}
    - name: sops-gpg
      secret:
        secretName: sops-gpg
  volumeMounts:
    - name: custom-tools
      mountPath: /home/argocd/.config/kustomize/plugin/viaduct.ai/v1/ksops
    - name: gnupg-home
      mountPath: /home/argocd/.gnupg
  initContainers:
    - name: install-ksops
      image: viaductoss/ksops:v4.3.2  # v4.4.0 has no shell, using v4.3.2
      command: ["sh", "-c"]
      args:
        - |
          echo "Installing KSOPS toolchain..."
          # Copy binaries from ksops image
          cp /usr/local/bin/ksops /custom-tools/ksops
          cp /usr/local/bin/kustomize /custom-tools/kustomize
          chmod +x /custom-tools/*
          # Verify installations
          echo "Verifying installations:"
          /custom-tools/ksops version 2>/dev/null || echo "ksops: ready"
          /custom-tools/kustomize version
          ls -la /custom-tools/
          echo "KSOPS toolchain installation complete"
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
      securityContext:
        runAsUser: 999
        runAsGroup: 999
    - name: install-sops
      image: curlimages/curl:8.11.1
      command: ["sh", "-c"]
      args:
        - |
          echo "Installing SOPS..."
          curl -L -o /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.10.2/sops-v3.10.2.linux.amd64
          chmod +x /custom-tools/sops
          echo "Verifying SOPS installation:"
          /custom-tools/sops --version
          echo "SOPS installation complete"
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
      securityContext:
        runAsUser: 999
        runAsGroup: 999
    - name: import-gpg
      image: quay.io/argoproj/argocd:v3.2.2
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Setting up GPG..."
          export GNUPGHOME=/gnupg-home
          mkdir -p /gnupg-home
          chmod 700 /gnupg-home
          echo "Importing GPG key..."
          if [ -f /sops-gpg/sops.asc ]; then
            echo "use-agent" >> /gnupg-home/gpg.conf
            echo "pinentry-mode loopback" >> /gnupg-home/gpg.conf
            echo "allow-loopback-pinentry" >> /gnupg-home/gpg-agent.conf
            echo "batch" >> /gnupg-home/gpg.conf
            echo "no-tty" >> /gnupg-home/gpg.conf
            gpg --batch --import /sops-gpg/sops.asc 2>&1
            echo "GPG key imported successfully"
            # Fix ownership
            chown -R 999:999 /gnupg-home
            # List keys to verify
            gpg --list-secret-keys 2>&1 || true
          else
            echo "No GPG key found to import"
          fi
          echo "GPG setup complete"
      volumeMounts:
        - name: gnupg-home
          mountPath: /gnupg-home
        - name: sops-gpg
          mountPath: /sops-gpg
          readOnly: true
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        runAsNonRoot: true
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

controller:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

server:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

dex:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

redis:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

applicationSet:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert

notifications:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - talos-eggbert