# ArgoCD values override for Talos cluster
configs:
  params:
    # Enable Helm support and alpha plugins (including ksops) in Kustomize builds
    kustomize.buildOptions: "--enable-helm --enable-alpha-plugins --enable-exec"
    # Keep the insecure mode we just configured
    server.insecure: true

# Install ksops in standard ArgoCD repo server
repoServer:
  env:
    - name: KUSTOMIZE_PLUGIN_HOME
      value: /home/argocd/.config/kustomize/plugin
    - name: XDG_CONFIG_HOME
      value: /home/argocd/.config
  volumes:
    - name: custom-tools
      emptyDir: {}
  volumeMounts:
    - name: custom-tools
      mountPath: /home/argocd/.config/kustomize/plugin/viaduct.ai/v1/ksops
  initContainers:
    - name: install-ksops
      image: viaductoss/ksops:v4.3.2
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Installing ksops..."
          cp /usr/local/bin/ksops /custom-tools/ksops
          chmod +x /custom-tools/ksops
          echo "ksops installation complete"
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        runAsNonRoot: false