# Inherited from original media deployment
persistentVolumeClaims:
  sabnzbd-config:
    requestStorage: '5Gi'
    storageClassName: 'nfs'

# Application configuration with Eweka news server
application:
  config:
    filename: 'sabnzbd.ini'
    contents: |
      [misc]
      language = en
      queue_limit = 20
      port = 8080
      api_key = $apiKey
      nzb_key = $nzbKey
      download_dir = Downloads/incomplete
      complete_dir = Downloads/complete
      host_whitelist =
      auto_browser = 0
      par2_multicore = 1
      folder_rename = 1
      pause_on_pwrar = 1
      ignore_samples = 1
      deobfuscate_final_filenames = 1
      direct_unpack = 1
      history_retention = 0
      enable_recursive = 1
      
      [servers]
      [[news.eweka.nl]]
      name = news.eweka.nl
      displayname = Eweka
      host = news.eweka.nl
      port = 563
      username = 48ef10df07d993e3
      password = $ewekaPassword
      connections = 50
      ssl = 1
      ssl_verify = 2
      enable = 1
      priority = 0
      
      [[news.newshosting.com]]
      name = news.newshosting.com
      displayname = Newshosting
      host = news.newshosting.com
      port = 563
      username = olgavcy7wc
      password = $newshostingPassword
      connections = 100
      ssl = 1
      ssl_verify = 2
      enable = 1
      priority = 1
      
      [categories]
      [[*]]
      name = *
      order = 0
      pp = 3
      script = None
      dir = 
      newzbin = 
      priority = 0
    # Secrets are provided via SOPS-encrypted secret, not generated by Helm
    secrets: []

# Extra environment variables to inject the passwords from secret
deployment:
  container:
    env:
      - name: PUID
        value: "1000"
      - name: PGID
        value: "3001"
      - name: 'ewekaPassword'
        valueFrom:
          secretKeyRef:
            name: sabnzbd-passwords
            key: ewekaPassword
      - name: 'newshostingPassword'
        valueFrom:
          secretKeyRef:
            name: sabnzbd-passwords
            key: newshostingPassword
  # Add VPN sidecar for secure connections
  additionalContainers:
    - name: gluetun
      image: qmcgaw/gluetun:latest
      imagePullPolicy: Always
      env:
      - name: DNS_ADDRESS
        value: "10.255.255.1"
      - name: TZ
        value: America/Chicago
      - name: VPN_SERVICE_PROVIDER
        value: windscribe
      - name: VPN_TYPE
        value: openvpn
      - name: SERVER_REGIONS
        value: "US Central"
      - name: WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL
        value: "14s"
      - name: WIREGUARD_MTU
        value: "1410"
      - name: HEALTH_VPN_DURATION_INITIAL
        value: "10s"
      - name: HEALTH_VPN_DURATION_ADDITION
        value: "5s"
      envFrom:
      - secretRef:
          name: windscribe-openvpn-creds
      ports:
      - containerPort: 8080
        name: http-vpn
        protocol: TCP
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "128Mi"
          cpu: "100m"
      securityContext:
        capabilities:
          add:
          - NET_ADMIN

ingress:
  enabled: true
  className: nginx
  host: sabnzbd.asandov.local
  path: /
  pathType: Prefix
  annotations:
    external-dns.alpha.kubernetes.io/hostname: sabnzbd.asandov.local