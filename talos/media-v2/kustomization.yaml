apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: media-v2

resources:
- shared-pvcs.yaml
- resources/external-truenas-svc.yaml
- resources/jellyfin-ingress.yaml
- configs/setup-rbac.yaml
- configs/api-key-sync-sidecar.yaml
- configs/api-key-sync-rbac.yaml
- configs/prowlarr-complete-setup-job.yaml
- configs/radarr-full-config-job.yaml
- configs/sonarr-full-config-job.yaml
- configs/bazarr-setup-job.yaml
- configs/jellyseerr-setup-job.yaml
- configs/jellyseerr-config-job.yaml

generators:
- secrets-generator.yaml

# VPN is now in separate windscribe namespace
#patches:
#- target:
#    kind: Deployment
#    name: sabnzbd
#  path: patches/add-vpn-sidecars.yaml

# API sync sidecars
patches:
- target:
    kind: Deployment
    name: radarr
  patch: |-
    - op: add
      path: /spec/template/spec/containers/-
      value:
        name: api-key-sync
        image: alpine/k8s:1.28.3
        command: ["/bin/sh"]
        args: ["/scripts/sync-api-key.sh"]
        env:
        - name: SERVICE_NAME
          value: "radarr"
        - name: SECRET_KEY
          value: "radarr-api-key"
        - name: CONFIG_PATH
          value: "/config/config.xml"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: api-sync-script
          mountPath: /scripts
          readOnly: true
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: api-sync-script
        configMap:
          name: api-key-sync-sidecar
          defaultMode: 0755
    - op: replace
      path: /spec/template/spec/serviceAccountName
      value: media-apps
- target:
    kind: Deployment
    name: sonarr
  patch: |-
    - op: add
      path: /spec/template/spec/containers/-
      value:
        name: api-key-sync
        image: alpine/k8s:1.28.3
        command: ["/bin/sh"]
        args: ["/scripts/sync-api-key.sh"]
        env:
        - name: SERVICE_NAME
          value: "sonarr"
        - name: SECRET_KEY
          value: "sonarr-api-key"
        - name: CONFIG_PATH
          value: "/config/config.xml"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: api-sync-script
          mountPath: /scripts
          readOnly: true
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: api-sync-script
        configMap:
          name: api-key-sync-sidecar
          defaultMode: 0755
    - op: replace
      path: /spec/template/spec/serviceAccountName
      value: media-apps
- target:
    kind: Deployment
    name: prowlarr
  patch: |-
    - op: add
      path: /spec/template/spec/containers/-
      value:
        name: api-key-sync
        image: alpine/k8s:1.28.3
        command: ["/bin/sh"]
        args: ["/scripts/sync-api-key.sh"]
        env:
        - name: SERVICE_NAME
          value: "prowlarr"
        - name: SECRET_KEY
          value: "prowlarr-api-key"
        - name: CONFIG_PATH
          value: "/config/config.xml"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: api-sync-script
          mountPath: /scripts
          readOnly: true
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: api-sync-script
        configMap:
          name: api-key-sync-sidecar
          defaultMode: 0755
    - op: replace
      path: /spec/template/spec/serviceAccountName
      value: media-apps
- target:
    kind: Deployment
    name: bazarr
  patch: |-
    - op: add
      path: /spec/template/spec/containers/-
      value:
        name: api-key-sync
        image: alpine/k8s:1.28.3
        command: ["/bin/sh"]
        args: ["/scripts/sync-api-key.sh"]
        env:
        - name: SERVICE_NAME
          value: "bazarr"
        - name: SECRET_KEY
          value: "bazarr-api-key"
        - name: CONFIG_PATH
          value: "/config/config.yaml"
        volumeMounts:
        - name: config
          mountPath: /config
        - name: api-sync-script
          mountPath: /scripts
          readOnly: true
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: api-sync-script
        configMap:
          name: api-key-sync-sidecar
          defaultMode: 0755
    - op: replace
      path: /spec/template/spec/serviceAccountName
      value: media-apps

helmCharts:
- name: sonarr
  repo: https://media-servarr.shw.al/charts
  version: 0.8.4
  releaseName: sonarr
  namespace: media-v2
  valuesFile: values-overrides/sonarr-values.yaml
    
- name: radarr
  repo: https://media-servarr.shw.al/charts
  version: 0.18.0
  releaseName: radarr
  namespace: media-v2
  valuesFile: values-overrides/radarr-values.yaml

- name: prowlarr
  repo: https://media-servarr.shw.al/charts
  version: 0.16.0
  releaseName: prowlarr
  namespace: media-v2
  valuesFile: values-overrides/prowlarr-values.yaml

- name: sabnzbd
  repo: https://media-servarr.shw.al/charts
  version: 0.6.5
  releaseName: sabnzbd
  namespace: media-v2
  valuesFile: values-overrides/sabnzbd-values.yaml

- name: bazarr
  repo: https://media-servarr.shw.al/charts
  version: 0.8.3
  releaseName: bazarr
  namespace: media-v2
  valuesFile: values-overrides/bazarr-values.yaml

- name: homarr
  repo: https://media-servarr.shw.al/charts
  version: 0.16.0
  releaseName: homarr
  namespace: media-v2
  valuesFile: values-overrides/homarr-values.yaml

- name: jellyseerr
  repo: https://media-servarr.shw.al/charts
  version: 0.5.0
  releaseName: jellyseerr
  namespace: media-v2
  valuesFile: values-overrides/jellyseerr-values.yaml
