# kube-prometheus-stack values
# Non-default values only

prometheus:
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    hosts:
      - prometheus.asandov.local
    paths:
      - /
    pathType: Prefix
  prometheusSpec:
    # Removed remoteWrite to TrueNAS - storing locally on ramhaus
    retention: 30d
    retentionSize: 100GB
    nodeSelector:
      kubernetes.io/hostname: talos-ramhaus
    serviceMonitorSelectorNilUsesHelmValues: false  # default: true
    ruleSelectorNilUsesHelmValues: false  # default: true
    podMonitorSelectorNilUsesHelmValues: false  # default: true
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: nfs
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 200Gi
    additionalScrapeConfigs:
      - job_name: "truenas-gpu"
        static_configs:
          - targets: ["truenas.asandov.local:9835"]
            labels:
              instance: "truenas"
      - job_name: "truenas-graphite"
        static_configs:
          - targets: ["truenas.asandov.local:9108"]
            labels:
              instance: "truenas"
      - job_name: "truenas-dcgm"
        static_configs:
          - targets: ["truenas.asandov.local:9400"]
            labels:
              instance: "truenas"
      - job_name: "truenas-pdu"
        static_configs:
          - targets: ["truenas.asandov.local:8088"]
            labels:
              instance: "truenas"

alertmanager:
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    hosts:
      - alerts.asandov.local
    paths:
      - /
    pathType: Prefix
  alertmanagerSpec:
    nodeSelector:
      kubernetes.io/hostname: talos-ramhaus

grafana:
  enabled: true
  replicas: 2
  revisionHistoryLimit: 5
  headlessService: true
  nodeSelector:
    kubernetes.io/hostname: talos-ramhaus
  plugins:
    - ae3e-plotly-panel
  # Fix redirect loop when behind TLS-terminating proxy
  grafana.ini:
    server:
      root_url: https://grafana.local.asandov.com
    auth.generic_oauth:
      enabled: true
      name: Authentik
      allow_sign_up: true
      client_id: $__env{AUTHENTIK_CLIENT_ID}
      client_secret: $__env{AUTHENTIK_CLIENT_SECRET}
      scopes: openid profile email
      auth_url: https://auth.local.asandov.com/application/o/authorize/
      token_url: https://auth.local.asandov.com/application/o/token/
      api_url: https://auth.local.asandov.com/application/o/userinfo/
      role_attribute_path: contains(groups, 'Grafana Admins') && 'Admin' || contains(groups, 'Grafana Editors') && 'Editor' || 'Viewer'
  # Authentik OAuth credentials - create secret 'grafana-authentik-oauth' with AUTHENTIK_CLIENT_ID and AUTHENTIK_CLIENT_SECRET
  envFromSecrets:
    - name: grafana-authentik-oauth
      optional: true
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      external-dns.alpha.kubernetes.io/target: 10.0.7.201
    hosts:
      - grafana.asandov.local
    path: /
  # TrueNAS dashboard provisioning
  extraConfigmapMounts:
    - name: dashboard-truenas-overview
      mountPath: /etc/grafana/provisioning/dashboards/truenas/truenas-overview
      configMap: dashboard-truenas-overview
      readOnly: true
    - name: dashboard-truenas-app-health
      mountPath: /etc/grafana/provisioning/dashboards/truenas/app-health-overview
      configMap: dashboard-truenas-app-health
      readOnly: true
    - name: dashboard-truenas-disk-insight
      mountPath: /etc/grafana/provisioning/dashboards/truenas/truenas-disk-insight
      configMap: dashboard-truenas-disk-insight
      readOnly: true
    - name: dashboard-truenas-temperature
      mountPath: /etc/grafana/provisioning/dashboards/truenas/truenas-temperature
      configMap: dashboard-truenas-temperature
      readOnly: true
    - name: dashboard-nvidia-gpu
      mountPath: /etc/grafana/provisioning/dashboards/truenas/nvidia-gpu
      configMap: dashboard-nvidia-gpu
      readOnly: true
    - name: dashboard-ups-status
      mountPath: /etc/grafana/provisioning/dashboards/truenas/ups-status
      configMap: dashboard-ups-status
      readOnly: true
    # ArgoCD dashboard
    - name: dashboard-argocd
      mountPath: /etc/grafana/provisioning/dashboards/argocd
      configMap: dashboard-argocd
      readOnly: true
    # Traefik dashboard
    - name: dashboard-traefik
      mountPath: /etc/grafana/provisioning/dashboards/traefik
      configMap: dashboard-traefik
      readOnly: true
    # Authentik dashboard
    - name: dashboard-authentik
      mountPath: /etc/grafana/provisioning/dashboards/authentik
      configMap: dashboard-authentik
      readOnly: true
    # cert-manager dashboard
    - name: dashboard-cert-manager
      mountPath: /etc/grafana/provisioning/dashboards/cert-manager
      configMap: dashboard-cert-manager
      readOnly: true
    # Media apps dashboard
    - name: dashboard-exportarr
      mountPath: /etc/grafana/provisioning/dashboards/media
      configMap: dashboard-exportarr
      readOnly: true
    # Starlink dashboard
    - name: dashboard-starlink
      mountPath: /etc/grafana/provisioning/dashboards/starlink
      configMap: dashboard-starlink
      readOnly: true
    # Security dashboards
    - name: dashboard-trivy-operator
      mountPath: /etc/grafana/provisioning/dashboards/security/trivy
      configMap: dashboard-trivy-operator
      readOnly: true
    - name: dashboard-falco
      mountPath: /etc/grafana/provisioning/dashboards/security/falco
      configMap: dashboard-falco
      readOnly: true
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: "truenas"
          orgId: 1
          folder: "TrueNAS"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/truenas
        - name: "argocd"
          orgId: 1
          folder: "ArgoCD"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/argocd
        - name: "traefik"
          orgId: 1
          folder: "Traefik"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/traefik
        - name: "authentik"
          orgId: 1
          folder: "Authentik"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/authentik
        - name: "cert-manager"
          orgId: 1
          folder: "Cert-Manager"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/cert-manager
        - name: "media"
          orgId: 1
          folder: "Media Apps"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/media
        - name: "starlink"
          orgId: 1
          folder: "Starlink"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/starlink
        - name: "security"
          orgId: 1
          folder: "Security"
          type: file
          disableDeletion: false
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards/security

# Move remaining components to ramhaus
kube-state-metrics:
  nodeSelector:
    kubernetes.io/hostname: talos-ramhaus

prometheusOperator:
  nodeSelector:
    kubernetes.io/hostname: talos-ramhaus
